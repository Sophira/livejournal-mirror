<?_code # -*-bml-*-
{
    use strict;
    use JSON;
    use vars qw(%GET);

    my $err = sub {
        my $msg = shift;
        return JSON::objToJson({
            'error' => $msg,
        });
    };

    my $action = $GET{action};

    my %actions = (
        undorate   => sub {
            my ($journalid, $jitemid) = map { int($GET{$_}) } qw(journalid jitemid);

            return {
                status  => 'error',
                message => 'Missing args',
            } unless $journalid && $jitemid;

            my $result = LJ::reset_eventrate($journalid, $jitemid);

            return {
                status => 'OK',
                result => $result,
            };
        },

        rate   => sub {
            my ($journalid, $jitemid) = map { int($GET{$_}) } qw(journalid jitemid);

            return {
                status  => 'error',
                message => 'Missing args',
            } unless $journalid && $jitemid;

            my $result = LJ::set_eventrate($journalid, $jitemid);

            return {
                status => 'OK',
                result => $result,
            };
        },

        total   => sub {
            my ($journalid, $jitemid) = map { int($GET{$_}) } qw(journalid jitemid);

            return {
                status  => 'error',
                message => 'Missing args',
            } unless $journalid && $jitemid;

            my $result = LJ::get_eventratescounters($journalid,$jitemid);

            return {
                status => 'OK',
                result => $result,
            };
        },

        list  => sub {
            my ($journalid, $jitemid, $skip, $limit) =
                map { int($GET{$_}) } qw(journalid jitemid skip limit);

            $skip ||= 0; $limit ||= 10;

            return {
                status  => 'error',
                message => 'Missing args',
            } unless $journalid && $jitemid;

            my @result = LJ::get_eventrates(
                journalid   => $journalid,
                jitemid     => $jitemid,
                limits      => "'$skip', '$limit'",
            );

            return {
                status => 'OK',
                result => \@result,
            };
        },
    );

    if (exists($actions{$action})) {
        my $data = $actions{$action}->();
        return JSON::objToJson($data) if $data;
        return $err->('Malfunction'); # :)
    } else {
        return $err->('Wrong args (no action provided)');
    }
}
_code?>
