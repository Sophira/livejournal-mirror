#! /usr/bin/perl
use strict;
require "$ENV{'LJHOME'}/cgi-bin/ljlib.pl";

my $base = shift @ARGV || 1;

my $dbh = LJ::get_db_reader();
my $max = $dbh->selectrow_array("SELECT MAX(userid) FROM user")+0;

print "Populating userids up through $max\n";

while ($base <= $max) {
    my $u = LJ::load_userid($base);

    if ($u && !$u->is_expunged) {
        $u->set_next_birthday;

        if ($u->is_person && $u->prop("opt_bdaymail")) {
            $u->subscribe( event => 'Birthday', method => 'Inbox' );
            $u->subscribe( event => 'Birthday', method => 'Email' );
            $u->set_prop("opt_bdaymail", undef);
        }
    }

    if ($base % 10000 == 0) {
        print "Updated through userid: $base\n";
    }

    $base++;
}

print "All done!\n";

1;
