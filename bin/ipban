#!/usr/bin/perl
#

require "$ENV{'LJHOME'}/cgi-bin/ljlib.pl";

my $cmd = shift @ARGV;
my $ip = shift @ARGV;
unless ($cmd eq "list" || (($cmd eq "add" || $cmd eq "remove") && $ip)) {
    die "Usage: ipban {add|remove} <ip>\n";
}

my $dbh = LJ::get_dbh("master");
if ($cmd eq "add") {
    $dbh->do("INSERT INTO ipban (ip, bandate) VALUES (?,NOW())", undef, $ip);
    LJ::procnotify_add($dbh, "ban_ip", { 'ip' => $ip });
    exit;
}

if ($cmd eq "remove") {
    $dbh->do("DELETE FROM ipban WHERE ip=?", undef, $ip);
    LJ::procnotify_add($dbh, "unban_ip", { 'ip' => $ip });
    exit;
}

if ($cmd eq "list") {
    print "---Banned IP------Date Added---\n";
    my $sth = $dbh->prepare("SELECT ip,bandate FROM ipban ORDER BY bandate asc");
    $sth->execute;
    while (my ($ip, $date) = $sth->fetchrow_array) {
        printf "%-15s  $date\n", $ip;
    }
}
