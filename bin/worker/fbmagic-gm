#!/usr/bin/perl

# Gearman FB::Magick worker
#
# Brad Whitaker <whitaker@danga.com>
#
# * Requires fotobilder.pl to get at full API, but only
#   does operations such as scale, thumbnail, and other
#   alterations available via FB::Magick
#

use strict;
use lib "$ENV{LJHOME}/cgi-bin";
require "ljlib.pl";
require "fotobilder.pl";
use Gearman::Worker;
use Image::Magick;
use LJ::Worker::Gearman;
use FB::Magick;
use FB::Job;

gearman_decl(scale_image     => \&scale_image);
gearman_decl(thumbnail_image => \&thumbnail_image);
gearman_decl(fbmagick        => \&fbmagick);
gearman_work();

sub scale_image {
    my $job = shift;

    return FB::Job->do_as_gearman
        ( job_name => 'scale_image',
          arg_ref  => $job->{argref},
          task_ref => \&FB::Gpic::_load_scaled_do,
          );
}

sub thumbnail_image {
    my $job = shift;

    return FB::Job->do_as_gearman
        ( job_name => 'thumbnail_image',
          arg_ref  => $job->{argref},
          task_ref => \&FB::Upic::_thumbnail_gpic_do,
          );
}

sub fbmagick {
    my $job = shift;

    return FB::Job->do_as_gearman(
                                  job_name => 'fbmagick',
                                  arg_ref  => $job->{argref},
                                  task_ref => \&FB::Upic::_fbmagick_do,
                                  );
}
