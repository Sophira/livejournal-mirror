#!/usr/bin/perl
use strict;
use lib "$ENV{LJHOME}/cgi-bin";
use LJ::NewWorker::Manual;
LJ::NewWorker::Manual::CategoryRecentPosts->start();

################################################################################

package LJ::NewWorker::Manual::CategoryRecentPosts;

use strict;
use lib "$ENV{LJHOME}/cgi-bin";
use base 'LJ::NewWorker::Manual';

use LJ::Browse;

# how long to wait if we didn't process any at all
my $sleep_when_idle;

## how much entries are to fetch from each community
my $max_count_post_per_comm;

my $verbose;

sub BEGIN {
    $sleep_when_idle = 600;
    $verbose = 0;
    $max_count_post_per_comm = 30;
}

sub options {
    my $self = shift;
    return (
        $self->SUPER::options(),
    );
}

sub help {
    my $self = shift;
    return
        $self->SUPER::help() .
        "-u | --user login  work on one specific user\n";
}

sub work {
    my $class = shift;
    my @uids;

    my $verbose = $class->verbose();

    my $dbh = LJ::get_db_writer();

    my $journals = $dbh->selectall_arrayref ("SELECT catid, journalid FROM categoryjournals", { Slice => {} });
    foreach my $rec (@$journals) {
        my $journalid = $rec->{journalid};
        my @last_jitemid = $dbh->selectrow_array ("SELECT max(jitemid) FROM category_recent_posts WHERE journalid = ?", undef, $journalid);

        my $u = LJ::load_userid($journalid);
        my @recent = LJ::get_recent_items({
            itemshow    => $max_count_post_per_comm,
            err         => undef,
            userid      => $u->{userid},
            clusterid   => $u->{clusterid},
            remote      => undef,
            afterid     => $last_jitemid[0],
            order       => 'logtime',
        });

        foreach my $entry (@recent) {
            my $sth = $dbh->prepare ("INSERT INTO category_recent_posts (jitemid, timecreate, journalid) VALUES (?, ?, ?)");
            $sth->execute($entry->{itemid}, $entry->{logtime}, $journalid);

            ## Add tags for every entry
            my $e_obj = LJ::Entry->new ($u->{userid}, jitemid => $entry->{itemid});
            my @tags = $e_obj->tags;
            if (scalar @tags) {
                my $cat = LJ::Browse->load_by_id ($rec->{catid});
                next unless $cat;
                my $v = $cat->vertical;
                $v->save_tags (is_seo => 0, tags => [ map { { tag => $_, journalid => $u->{userid}, jitemid => $entry->{itemid} } } @tags ] )
                    if $v;
            }
        }

    }

    return 0;
}

sub on_idle {
    return sleep $sleep_when_idle;
}

sub debug {
    print STDERR @_, "\n" if $verbose;
}

1;
