<?_code
{
    use strict;
    use vars qw(%FORM);

    return unless $FORM{'lang'};
    my $l = LJ::Lang::get_lang($FORM{'lang'});
    return unless $l;

    if (LJ::did_post()) {
        my $remote = LJ::get_remote();

        my $cval = $l->{'lncode'};
        if ($remote) {
            LJ::set_userprop($remote, "browselang", $l->{'lncode'});

            if ($remote->{'_session'}->{'exptype'} eq 'long') {
                $cval = [ $l->{'lncode'}, $remote->{'_session'}->{'timeexpire'} ];
            }
        }

        $COOKIE{'langpref'} = $cval . "/" . time();
        BML::set_language($l->{'lncode'});
    }

    return;
}
_code?><?page
title=><?_ml .title _ml?>
body<=

<?_code
{
    use strict;
    use vars qw(%FORM);

    my $curr = BML::get_language();
    my $ret;

    $ret .= "<?_ml .select _ml?><form method='post' action='setlang.bml'>";

    $ret .= "<table cellpadding='10'><tr valign='top' align='left'><td>";
    my $ct = 0;
    my $switch = @LJ::LANGS / 2;
    
    foreach my $code (@LJ::LANGS) {
        my $l = LJ::Lang::get_lang($code);
        my $checked = $code eq $curr ? "checked='checked'" : "";
        my $item = "langname.$code";
        my $namethislang = BML::ml($item);
        my $namenative = LJ::Lang::get_text($l->{'lncode'}, $item);
        $ret .= "<p><input type='radio' $checked name='lang' value='$code' id='sel$code'> <label for='sel$code'>$namenative";
        $ret .= " ($namethislang)" if $namethislang ne $namenative;
        $ret .= "</label></p>\n";
        
        if ($switch && ++$ct >= $switch) {
            $ret .= "</td><td>"; $switch = 0;
        }
    }
    
    $ret .= "</td></tr></table>";
    
    $ret .= "<p><input type='submit' value='<?_ml .switch _ml?>' /></p></form>";

    return $ret;

}
_code?>

<=body
page?>
