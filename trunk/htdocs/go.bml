<?_code
{
 use strict;
 use vars qw($title $body %GET %POST);

 $title = "Error";
 $body = "No parameters given";

 # S2 Redirector
 if ($POST{'redir_type'} eq "monthview") {
     my $user = LJ::canonical_username($POST{'redir_user'});
     my $vhost;
     $vhost = $POST{'redir_vhost'} if $POST{'redir_vhost'}=~/users|tilde|community|front|other/;
     if ($vhost eq "other") {
         # FIXME: lookup their domain alias, and make vhost be "other:domain.com";
     }
     my $base = LJ::journal_base($user, $vhost);
     return "Bogus redir_key" unless $POST{'redir_key'} =~/^(\d\d\d\d)(\d\d)$/;
     my ($year, $month) = ($1, $2);
     return BML::redirect("$base/$year/$month/");
 }

 # prev/next talkread links
 my $itemid = $GET{'itemid'}+0;
 if ($GET{'journal'} && $itemid) 
 {
     my $journal = $GET{'journal'};
     my $u = LJ::load_user($journal);

     # sanity check
     unless ($u) {
         $body = "User not found";
         return;
     }
     my $journalid = $u->{'userid'}+0;

     $itemid = int($itemid / 256);
     
     my $jumpid = 0;
     $title = "No Entry";
     
     if ($GET{'dir'} eq "next") {
         $jumpid = LJ::get_itemid_after2($u, $itemid);
         $body = "There is no journal entry following this one.";
     } elsif ($GET{'dir'} eq "prev") {
         $jumpid = LJ::get_itemid_before2($u, $itemid);
         $body = "There is no journal entry preceeding this one.";
     }

     if ($jumpid) {
         return BML::redirect(LJ::journal_base($u) . "/$jumpid.html");
     }
 }

 return;
}
_code?><?page
title=><?_code return $title; _code?>
body=><?_code return $body; _code?>
page?><?_c <LJDEP>
link: htdocs/talkread.bml
</LJDEP> _c?>
